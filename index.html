<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Bus Tracking - Kolkata</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .main-container {
            flex: 1;
            display: flex;
            gap: 24px;
            padding: 24px;
            max-height: calc(100vh - 88px);
        }
        
        .map-container {
            flex: 1;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .sidebar {
            width: 380px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .passenger-info {
            background: linear-gradient(135deg, #FF6B6B, #FF8E8E);
            color: white;
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }
        
        .passenger-info h3 {
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 600;
        }
        
        .info-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        .info-row:last-child {
            margin-bottom: 0;
        }
        
        .info-icon {
            width: 18px;
            height: 18px;
            opacity: 0.9;
        }
        
        .route-info {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 5px solid;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        
        .route-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .route-dn18 { border-left-color: #e74c3c; }
        .route-l238 { border-left-color: #3498db; }
        .route-s15 { border-left-color: #2ecc71; }
        
        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .route-name {
            font-weight: 700;
            font-size: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .eta {
            background: linear-gradient(45deg, #FFA726, #FF9800);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 14px;
            box-shadow: 0 3px 10px rgba(255, 167, 38, 0.3);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .bus-status {
            font-size: 14px;
            color: #555;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stops-info {
            font-size: 13px;
            color: #777;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 10px;
            line-height: 1.4;
        }
        
        .legend {
            background: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .legend h4 {
            margin-bottom: 16px;
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 14px;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s ease;
        }
        
        .legend-item:hover {
            background: #f8f9fa;
        }
        
        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .status-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
        }
        
        .simulation-running {
            background: linear-gradient(45deg, #4CAF50, #45a049) !important;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }
        
        .pulsing {
            animation: pulse 2s infinite;
        }
        
        .destination-marker {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            border: 3px solid white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(155, 89, 182, 0.4);
        }
        
        /* Custom scrollbar */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 3px;
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.3);
            border-radius: 3px;
        }
        
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <i data-lucide="bus" width="32" height="32"></i>
            Real-Time Bus Tracking - Kolkata
        </h1>
        <div class="controls">
            <button class="btn btn-primary" onclick="startSimulation()">
                <i data-lucide="play" width="18" height="18"></i>
                Start
            </button>
            <button class="btn btn-danger" onclick="stopSimulation()">
                <i data-lucide="pause" width="18" height="18"></i>
                Stop
            </button>
            <button class="btn btn-secondary" onclick="resetSimulation()">
                <i data-lucide="rotate-ccw" width="18" height="18"></i>
                Reset
            </button>
        </div>
    </div>
    
    <div class="main-container">
        <div class="map-container">
            <div id="map"></div>
            <div class="status-indicator" id="statusIndicator">
                <i data-lucide="pause-circle" width="18" height="18"></i>
                Simulation Stopped
            </div>
        </div>
        
        <div class="sidebar">
            <div class="passenger-info">
                <h3>
                    <i data-lucide="user" width="24" height="24"></i>
                    Passenger Journey
                </h3>
                <div class="info-row">
                    <i data-lucide="map-pin" class="info-icon"></i>
                    <span><strong>From:</strong> Park Street Metro Station</span>
                </div>
                <div class="info-row">
                    <i data-lucide="flag" class="info-icon"></i>
                    <span><strong>To:</strong> Central Kolkata</span>
                </div>
                <div class="info-row">
                    <i data-lucide="route" class="info-icon"></i>
                    <span><strong>Available Routes:</strong> DN18, L238</span>
                </div>
            </div>
            
            <div class="legend">
                <h4>
                    <i data-lucide="map" width="20" height="20"></i>
                    Route Legend
                </h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e74c3c;"></div>
                    <span>Route DN18 (Howrah - Salt Lake)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #3498db;"></div>
                    <span>Route L238 (Sealdah - Garia)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #2ecc71;"></div>
                    <span>Route S15 (Esplanade - Airport)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FF6B6B;"></div>
                    <span>Your Location (Park Street)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #9b59b6;"></div>
                    <span>Destination (Central)</span>
                </div>
            </div>
            
            <div id="routeInfo">
                <!-- Route information will be populated here -->
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Initialize map centered on Kolkata
        const map = L.map('map').setView([22.5726, 88.3639], 14);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        
        // Bus routes data with realistic Kolkata locations
        const routes = {
            DN18: {
                name: 'DN18',
                color: '#e74c3c',
                path: [
                    [22.5958, 88.2636], // Howrah Station
                    [22.5744, 88.3126], // Park Street (passenger pickup point)
                    [22.5726, 88.3639], // Central Kolkata (destination)
                    [22.5896, 88.4030], // Salt Lake
                ],
                stops: ['Howrah Station', 'Park Street', 'Central Kolkata', 'Salt Lake']
            },
            L238: {
                name: 'L238',
                color: '#3498db',
                path: [
                    [22.5675, 88.3364], // Sealdah
                    [22.5744, 88.3126], // Park Street (passenger pickup point)
                    [22.5726, 88.3639], // Central Kolkata (destination)
                    [22.5568, 88.3826], // Ballygunge
                    [22.4707, 88.3962], // Garia
                ],
                stops: ['Sealdah', 'Park Street', 'Central Kolkata', 'Ballygunge', 'Garia']
            },
            S15: {
                name: 'S15',
                color: '#2ecc71',
                path: [
                    [22.5675, 88.3364], // Esplanade
                    [22.5726, 88.3639], // Central
                    [22.5957, 88.4044], // Bidhannagar
                    [22.6540, 88.4473], // Airport
                ],
                stops: ['Esplanade', 'Central', 'Bidhannagar', 'Airport']
            }
        };
        
        // Passenger location (Park Street Metro) and destination (Central Kolkata)
        const passengerLocation = [22.5744, 88.3126]; // Park Street Metro
        const destinationLocation = [22.5726, 88.3639]; // Central Kolkata
        let passengerMarker, destinationMarker;
        
        // Bus markers and polylines
        let busMarkers = {};
        let routeLines = {};
        let simulationInterval;
        let isSimulating = false;
        
        // Bus positions (initially at start of routes)
        let busPositions = {
            DN18: { index: 0, progress: 0, direction: 1 },
            L238: { index: 0, progress: 0, direction: 1 },
            S15: { index: 0, progress: 0, direction: 1 }
        };
        
        // Custom icons
        const busIcon = (color) => L.divIcon({
            html: `<div style="background: ${color}; width: 28px; height: 28px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">ðŸšŒ</div>`,
            iconSize: [28, 28],
            className: 'custom-bus-icon'
        });
        
        const passengerIcon = L.divIcon({
            html: '<div style="background: #FF6B6B; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);">ðŸ‘¤</div>',
            iconSize: [32, 32],
            className: 'custom-passenger-icon pulsing'
        });
        
        const destinationIcon = L.divIcon({
            html: '<div class="destination-marker">ðŸŽ¯</div>',
            iconSize: [30, 30],
            className: 'custom-destination-icon'
        });
        
        // Initialize map elements
        function initializeMap() {
            // Add passenger marker
            passengerMarker = L.marker(passengerLocation, { icon: passengerIcon })
                .addTo(map)
                .bindPopup('<b>Your Location</b><br>Park Street Metro Station<br>Waiting for bus to Central Kolkata');
                
            // Add destination marker
            destinationMarker = L.marker(destinationLocation, { icon: destinationIcon })
                .addTo(map)
                .bindPopup('<b>Your Destination</b><br>Central Kolkata');
            
            // Add route lines and bus markers
            Object.keys(routes).forEach(routeId => {
                const route = routes[routeId];
                
                // Add route line
                routeLines[routeId] = L.polyline(route.path, {
                    color: route.color,
                    weight: 5,
                    opacity: 0.8
                }).addTo(map).bindPopup(`Route ${route.name}`);
                
                // Add bus marker
                busMarkers[routeId] = L.marker(route.path[0], { icon: busIcon(route.color) })
                    .addTo(map)
                    .bindPopup(`Bus ${route.name}<br>Status: At ${route.stops[0]}`);
            });
            
            updateRouteInfo();
        }
        
        // Calculate distance between two points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Calculate ETA based on current bus position and passenger location
        function calculateETA(routeId) {
            const route = routes[routeId];
            const busPos = busPositions[routeId];
            const currentLatLng = getCurrentBusPosition(routeId);
            
            // For routes that pass through Park Street, calculate time to reach passenger
            const parkStreetStopIndex = route.stops.findIndex(stop => stop === 'Park Street');
            
            if (parkStreetStopIndex === -1) {
                // Route doesn't go through Park Street
                return '--';
            }
            
            // Calculate distance from current bus position to Park Street
            const distanceToParkStreet = calculateDistance(
                currentLatLng.lat, currentLatLng.lng,
                passengerLocation[0], passengerLocation[1]
            );
            
            // Simulate realistic ETA (2-12 minutes based on distance and traffic)
            const baseTime = Math.max(2, Math.min(12, distanceToParkStreet * 10));
            const eta = Math.round(baseTime + Math.random() * 2); // Add some randomness
            
            return eta;
        }
        
        // Get current bus position based on progress
        function getCurrentBusPosition(routeId) {
            const route = routes[routeId];
            const busPos = busPositions[routeId];
            
            if (busPos.index >= route.path.length - 1) {
                return { lat: route.path[route.path.length - 1][0], lng: route.path[route.path.length - 1][1] };
            }
            
            const start = route.path[busPos.index];
            const end = route.path[busPos.index + 1];
            
            const lat = start[0] + (end[0] - start[0]) * busPos.progress;
            const lng = start[1] + (end[1] - start[1]) * busPos.progress;
            
            return { lat, lng };
        }
        
        // Update bus positions
        function updateBusPositions() {
            Object.keys(busPositions).forEach(routeId => {
                const route = routes[routeId];
                const busPos = busPositions[routeId];
                
                // Move bus along the route
                busPos.progress += 0.015 * busPos.direction; // Slightly slower for more realistic movement
                
                if (busPos.progress >= 1) {
                    busPos.progress = 0;
                    busPos.index += busPos.direction;
                    
                    if (busPos.index >= route.path.length - 1) {
                        busPos.direction = -1; // Reverse direction
                    } else if (busPos.index <= 0) {
                        busPos.direction = 1; // Forward direction
                    }
                }
                
                // Update marker position
                const currentPos = getCurrentBusPosition(routeId);
                busMarkers[routeId].setLatLng([currentPos.lat, currentPos.lng]);
                
                // Update popup content
                const currentStopIndex = Math.round(busPos.index);
                const currentStop = route.stops[Math.min(currentStopIndex, route.stops.length - 1)];
                busMarkers[routeId].getPopup().setContent(`Bus ${route.name}<br>Status: Near ${currentStop}<br>Direction: ${busPos.direction > 0 ? 'Forward' : 'Return'}`);
            });
            
            updateRouteInfo();
        }
        
        // Update route information in sidebar
        function updateRouteInfo() {
            const routeInfoContainer = document.getElementById('routeInfo');
            let html = '';
            
            Object.keys(routes).forEach(routeId => {
                const route = routes[routeId];
                const eta = isSimulating ? calculateETA(routeId) : '--';
                const busPos = busPositions[routeId];
                const currentStopIndex = Math.round(busPos.index);
                const currentStop = route.stops[Math.min(currentStopIndex, route.stops.length - 1)];
                
                // Check if this route serves the passenger's journey
                const servesJourney = route.stops.includes('Park Street') && route.stops.includes('Central Kolkata');
                const relevantClass = servesJourney ? ' relevant-route' : '';
                
                html += `
                    <div class="route-info route-${routeId.toLowerCase()}${relevantClass}">
                        <div class="route-header">
                            <span class="route-name">
                                <i data-lucide="bus" width="20" height="20"></i>
                                ${route.name}
                            </span>
                            <span class="eta">
                                <i data-lucide="clock" width="14" height="14"></i>
                                ${eta} min
                            </span>
                        </div>
                        <div class="bus-status">
                            <i data-lucide="map-pin" width="16" height="16"></i>
                            Near: ${currentStop}
                        </div>
                        <div class="bus-status">
                            <i data-lucide="navigation" width="16" height="16"></i>
                            Direction: ${busPos.direction > 0 ? 'Forward Route' : 'Return Route'}
                        </div>
                        ${servesJourney ? '<div class="bus-status"><i data-lucide="check-circle" width="16" height="16" style="color: #4CAF50;"></i>Available for your journey</div>' : ''}
                        <div class="stops-info">
                            <strong>Route:</strong> ${route.stops.join(' â†’ ')}
                        </div>
                    </div>
                `;
            });
            
            routeInfoContainer.innerHTML = html;
            
            // Re-initialize Lucide icons for dynamically added content
            lucide.createIcons();
        }
        
        // Start simulation
        function startSimulation() {
            if (isSimulating) return;
            
            isSimulating = true;
            const statusIndicator = document.getElementById('statusIndicator');
            statusIndicator.innerHTML = '<i data-lucide="play-circle" width="18" height="18"></i> Simulation Running';
            statusIndicator.className = 'status-indicator simulation-running';
            
            lucide.createIcons();
            simulationInterval = setInterval(updateBusPositions, 1000);
        }
        
        // Stop simulation
        function stopSimulation() {
            if (!isSimulating) return;
            
            isSimulating = false;
            const statusIndicator = document.getElementById('statusIndicator');
            statusIndicator.innerHTML = '<i data-lucide="pause-circle" width="18" height="18"></i> Simulation Stopped';
            statusIndicator.className = 'status-indicator';
            
            lucide.createIcons();
            if (simulationInterval) {
                clearInterval(simulationInterval);
            }
        }
        
        // Reset simulation
        function resetSimulation() {
            stopSimulation();
            
            // Reset bus positions
            busPositions = {
                DN18: { index: 0, progress: 0, direction: 1 },
                L238: { index: 0, progress: 0, direction: 1 },
                S15: { index: 0, progress: 0, direction: 1 }
            };
            
            // Reset bus markers to start positions
            Object.keys(routes).forEach(routeId => {
                const route = routes[routeId];
                busMarkers[routeId].setLatLng(route.path[0]);
                busMarkers[routeId].getPopup().setContent(`Bus ${route.name}<br>Status: At ${route.stops[0]}`);
            });
            
            updateRouteInfo();
        }
        
        // Initialize the map when page loads
        initializeMap();
    </script>
</body>
</html>